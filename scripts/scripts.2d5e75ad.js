"use strict";angular.module("sharedcostApp",["ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ui.router","angular-loading-bar","ui.bootstrap","ChartAngular"]).constant("settings",{api:"http://api.ov3rk1ll.com/sharedcosts"}).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){c.interceptors.push("errorInterceptor"),b.otherwise("/"),a.state("auth",{url:"/access_token={accessToken}&token_type={tokenType}&expires_in={expiresIn}",template:"auth",controller:["$state","$stateParams","$http","AuthService",function(a,b,c,d){d.login(b.accessToken)}]}).state("home",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl"}).state("projects",{url:"/list",templateUrl:"views/projectlist.html",controller:"ProjectlistCtrl",authenticate:!0}).state("createproject",{url:"/list/add",authenticate:!0,onEnter:["$stateParams","$state","$modal","Entry","$http","settings",function(){console.log("add form")}]}).state("project",{url:"/list/:id",templateUrl:"views/projectdetail.html",controller:"ProjectdetailCtrl",authenticate:!0,resolve:{current:["$stateParams","List",function(a,b){return b.get({id:a.id}).$promise}],entries:["$stateParams","Entry",function(a,b){return b.query({projectId:a.id}).$promise}]}}).state("project.edit",{url:"/entry/:entryid",authenticate:!0,onEnter:["$stateParams","$state","$modal","Entry","$http","settings","$location","current","entries",function(a,b,c,d,e,f,g,h,i){c.open({templateUrl:"views/entryedit.html",controller:"EntryeditCtrl",resolve:{item:function(){var b=g.search().clone?g.search().clone:a.entryid;for(var c in i)if(i[c].id==b)return i[c];return new d},project:function(){return h}}}).result.then(function(){b.go("project",{id:a.id},{reload:!0})},function(){b.go("project",{id:a.id})})}]})}]).run(["$rootScope","$state","AuthService","$cookies","$location",function(a,b,c,d,e){a.$state=b,a.$watch(c.isLoggedIn,function(b){a.$isLoggedIn=b,a.$currentUser=c.currentUser()}),a.$on("$stateChangeStart",function(a,d){d.authenticate&&!c.isLoggedIn()&&(b.transitionTo("home",{returnUrl:e.url()}),a.preventDefault())}),a.selectList=function(a){c.setCurrentList(a),b.go("project",{id:a.id})}}]),angular.module("sharedcostApp").factory("AuthService",["settings","$http","$state","$cookies","$location","waitingDialog",function(a,b,c,d,e,f){var g=null,h=null;return{oauth:function(){var a="174190054188-fnomfn083gohkmq9okkapqbevgitltnd.apps.googleusercontent.com",b="https://www.googleapis.com/auth/userinfo.email",c="http://ov3rk1ll.github.io/SharedCosts",d="token",e="https://accounts.google.com/o/oauth2/auth?scope="+b+"&client_id="+a+"&redirect_uri="+c+"&response_type="+d;window.location.replace(e)},login:function(h,i){var j=f.show("Signing you in...");b.post(a.api+"/login/google",{token:h}).success(function(a){var f=a.status;"ok"==f?(g=a.user,b.defaults.headers.common.session=a.session,d.authtoken=h,j.close(),i?e.url(i):c.go("home")):(d.authtoken="",j.close(),c.go("home"))}).error(function(a){console.log(a)})},logout:function(){b.get(a.api+"/logout").success(function(){g=null}).error(function(a){console.log(a)})},isLoggedIn:function(){return null!==g},currentUser:function(){return g},getCurrentList:function(){return h},setCurrentList:function(a){h=a}}}]).factory("errorInterceptor",["$q",function(a){return{request:function(b){return b||a.when(b)},requestError:function(b){return a.reject(b)},response:function(b){return b||a.when(b)},responseError:function(b){return b&&404===b.status,b&&403===b.status?void window.alert(b.data.error.message):(b&&b.status>=500,a.reject(b))}}}]),angular.module("sharedcostApp").factory("List",["$resource","settings",function(a,b){return a(b.api+"/projects/:id",{id:"@id"},{})}]).factory("Entry",["$resource","settings",function(a,b){return a(b.api+"/projects/:projectId/entries/:id",{projectId:"@projectId",id:"@id"},{})}]),angular.module("sharedcostApp").controller("MainCtrl",["$scope","$stateParams","AuthService","$cookies",function(a,b,c,d){d.authtoken&&c.login(d.authtoken,b.returnUrl),a.$watch(c.isLoggedIn,function(b){a.isLoggedIn=b,a.currentUser=c.currentUser()}),a.login=function(){c.oauth()},a.logout=function(){c.oauth()}}]),angular.module("sharedcostApp").controller("ProjectlistCtrl",["$scope","List","$rootScope",function(a,b){b.query(function(b){a.projects=b})}]),angular.module("sharedcostApp").directive("userbadge",function(){return{template:'<span class="label label-default"><img ng-src="{{ user.picture }}" alt="{{ user.name }}" class="img-circle" style="max-height: 18px;"> {{ user.name }}</span>',restrict:"E",scope:{user:"="}}}),angular.module("sharedcostApp").controller("ProjectdetailCtrl",["$scope","current","entries",function(a,b,c){a.project=b,a.entries=c,a.members=b.payments;var d=[];for(var e in a.members)d.push({label:a.members[e].name,value:a.members[e].paid});a.chartMembers={data:d}}]),angular.module("sharedcostApp").controller("NavigationCtrl",["$scope","$rootScope","List","AuthService",function(a,b,c,d){a.$watch(d.isLoggedIn,function(b){b&&c.query(function(b){a.projects=b})}),a.$watch(b.$state,function(a){console.log(a)}),a.login=function(){d.oauth()},a.logout=function(){d.oauth()}}]),angular.module("sharedcostApp").controller("EntryeditCtrl",["$scope","item","project","$location",function(a,b,c,d){d.search().clone&&(b.id=""),a.item=b,a.projectId=c.data.id,a.members=c.payments,a.dateOptions={startingDay:1},a.format="dd.MM.yyyy",a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.dismiss=function(){a.$dismiss()},a.save=function(){b.$save({projectId:a.projectId}).then(function(){a.$close(!0)})},a.remove=function(){window.confirm("Are you sure?")&&b.$delete({projectId:a.projectId}).then(function(){a.$close(!0)})}}]),angular.module("sharedcostApp").provider("waitingDialog",function(){var a=angular.element('<div class="modal-dialog modal-m"><div class="modal-content"><div class="modal-header"><h3 style="margin:0;"></h3></div><div class="modal-body"><div class="progress progress-striped active" style="margin-bottom:0;"><div class="progress-bar" style="width: 100%"></div></div></div></div></div>');this.$get=["$modal",function(b){return{show:function(c,d){"undefined"==typeof d&&(d={});var e=$.extend({progressType:"material-yellow-A700"},d);return"undefined"==typeof c&&(c="Loading"),a.find(".progress-bar").attr("class","progress-bar"),e.progressType&&a.find(".progress-bar").addClass("progress-bar-"+e.progressType),a.find("h3").text(c),b.open({template:a.html(),backdrop:"static",keyboard:!1})},hide:function(){$dialog.modal("hide")}}}]});